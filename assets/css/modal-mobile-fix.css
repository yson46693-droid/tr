/**
 * Modal Mobile Fix - Dynamic Height for Mobile Devices
 * إصلاح النماذج على الهواتف المحمولة - ارتفاع ديناميكي
 */

/* ===== Base Modal Dialog Fix ===== */
@media (max-width: 768px) {
    /* استخدام dynamic viewport height للنماذج على الهواتف */
    .modal-dialog {
        margin: 0.5rem !important;
        max-width: calc(100% - 1rem) !important;
        /* سيتم تعيين max-height ديناميكياً عبر JavaScript */
    }
    
    /* تطبيق الارتفاع الديناميكي على النماذج المفتوحة */
    .modal.show .modal-dialog,
    .modal.showing .modal-dialog {
        display: flex !important;
        flex-direction: column !important;
        max-height: calc(100vh - 1rem) !important;
        height: calc(100vh - 1rem) !important;
        /* سيتم تحديثه ديناميكياً عبر JavaScript */
    }
    
    /* تطبيق الارتفاع الديناميكي على محتوى النموذج */
    .modal.show .modal-content,
    .modal.showing .modal-content {
        display: flex !important;
        flex-direction: column !important;
        max-height: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
    }
    
    /* رأس النموذج - ثابت في الأعلى */
    .modal.show .modal-header,
    .modal.showing .modal-header {
        flex-shrink: 0 !important;
        padding: 1rem !important;
    }
    
    /* جسم النموذج - قابل للتمرير */
    .modal.show .modal-body,
    .modal.showing .modal-body {
        flex: 0 1 auto !important; /* تغيير من 1 1 auto إلى 0 1 auto لإزالة المساحة الفارغة */
        min-height: 0 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        /* تقليل padding-bottom - فقط عند الحاجة للتمرير */
        padding-bottom: 1rem !important;
        /* إزالة أي max-height محدد مسبقاً */
        max-height: none !important;
        height: auto !important;
        position: relative !important;
    }
    
    /* تذييل النموذج - ثابت في الأسفل */
    .modal.show .modal-footer,
    .modal.showing .modal-footer {
        flex-shrink: 0 !important;
        padding: 1rem !important;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)) !important;
        background-color: #fff !important;
        /* التأكد من أن التذييل مرئي دائماً */
        position: relative !important;
        z-index: 10 !important;
        border-top: 1px solid #dee2e6 !important;
        margin-top: 0 !important; /* إزالة margin-top: auto لمنع المساحة الفارغة */
    }
}

/* ===== Fullscreen Modals on Mobile ===== */
@media (max-width: 768px) {
    .modal-fullscreen-md-down,
    .modal-fullscreen-sm-down {
        padding: 0 !important;
    }
    
    .modal-fullscreen-md-down .modal-dialog,
    .modal-fullscreen-sm-down .modal-dialog {
        margin: 0;
        max-width: 100%;
        width: 100%;
        height: 100dvh;
        max-height: 100dvh;
    }
    
    .modal-fullscreen-md-down .modal-content,
    .modal-fullscreen-sm-down .modal-content {
        height: 100%;
        max-height: 100dvh;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
}

/* ===== Large Modals (modal-xl, modal-lg) ===== */
@media (max-width: 768px) {
    .modal-xl .modal-dialog,
    .modal-lg .modal-dialog {
        max-width: calc(100% - 1rem);
        margin: 0.5rem;
    }
    
    .modal-xl .modal-content,
    .modal-lg .modal-content {
        max-height: calc(100dvh - 1rem);
    }
}

/* ===== Scrollable Modal Body Fix - Bootstrap modal-dialog-scrollable ===== */
@media (max-width: 768px) {
    /* إعادة تعريف modal-dialog-scrollable للعمل بشكل صحيح على الهواتف */
    /* هذا مهم جداً - نحتاج تجاوز سلوك Bootstrap الافتراضي */
    .modal.show .modal-dialog-scrollable,
    .modal.showing .modal-dialog-scrollable {
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        max-height: calc(100vh - 1rem) !important;
        height: calc(100vh - 1rem) !important;
        /* سيتم تحديثه ديناميكياً عبر JavaScript */
    }
    
    /* منع overflow على modal-content في modal-dialog-scrollable */
    /* هذا هو المفتاح - Bootstrap يجعل modal-content scrollable، نحتاج تغيير ذلك */
    .modal.show .modal-dialog-scrollable .modal-content,
    .modal.showing .modal-dialog-scrollable .modal-content {
        display: flex !important;
        flex-direction: column !important;
        max-height: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
        overflow-y: hidden !important;
        overflow-x: hidden !important;
        /* إزالة overflow-y من modal-content - هذا مهم جداً */
    }
    
    /* جعل modal-body scrollable بدلاً من modal-content */
    /* هذا هو الحل - نقل التمرير من modal-content إلى modal-body */
    .modal.show .modal-dialog-scrollable .modal-body,
    .modal.showing .modal-dialog-scrollable .modal-body {
        flex: 0 1 auto !important; /* تغيير من 1 1 auto إلى 0 1 auto لإزالة المساحة الفارغة */
        min-height: 0 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        max-height: calc(100vh - 250px) !important; /* ارتفاع مناسب مع احتياطي للهيدر والفوتر */
        height: auto !important;
        padding-bottom: 1rem !important; /* تقليل padding-bottom */
        position: relative !important;
    }
    
    .modal.show .modal-dialog-scrollable .modal-header,
    .modal.showing .modal-dialog-scrollable .modal-header {
        flex-shrink: 0 !important;
    }
    
    .modal.show .modal-dialog-scrollable .modal-footer,
    .modal.showing .modal-dialog-scrollable .modal-footer {
        flex-shrink: 0 !important;
        background-color: #fff !important;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)) !important;
        border-top: 1px solid #dee2e6 !important;
        margin-top: 0 !important; /* إزالة margin-top: auto لمنع المساحة الفارغة */
        position: relative !important;
        z-index: 10 !important;
    }
    
    /* تجاوز أي CSS متعارض من header.php */
    .modal-dialog-scrollable .modal-body {
        max-height: none !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }
    
    /* تجاوز CSS من header.php الذي يحدد max-height */
    .modal-dialog.modal-dialog-scrollable .modal-body {
        max-height: none !important;
        overflow-y: auto !important;
    }
    
    .modal-dialog.modal-lg.modal-dialog-scrollable .modal-body {
        max-height: none !important;
        overflow-y: auto !important;
    }
    
    .modal-dialog.modal-xl.modal-dialog-scrollable .modal-body {
        max-height: none !important;
        overflow-y: auto !important;
    }
}

/* ===== Specific Modal Fixes ===== */
@media (max-width: 768px) {
    /* نماذج نقل المنتجات */
    #generalTransferModal .modal-body,
    #salesRepTransferModal .modal-body {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px) + 30px);
    }
    
    /* نماذج إضافة العملاء */
    #addCustomerModal .modal-body,
    #addLocalCustomerModal .modal-body,
    #addCompanyCustomerModal .modal-body {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px) + 30px);
    }
    
    /* نماذج الفواتير */
    #addInvoiceModal .modal-body,
    #createInvoiceModal .modal-body {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px) + 30px);
    }
    
    /* نماذج أخرى */
    #createReturnModal .modal-body,
    #customerPurchaseHistoryModal .modal-body,
    #customerHistoryModal .modal-body {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px) + 30px);
    }
    
    /* ===== إصلاح ظهور الأزرار في addCustomerModal على الهاتف ===== */
    #addCustomerModal.modal-fullscreen-md-down .modal-footer {
        position: sticky !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 1056 !important;
        background: rgba(255, 255, 255, 0.98) !important;
        backdrop-filter: blur(6px) !important;
        border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1) !important;
        padding-top: 1rem !important;
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)) !important;
        margin-top: 0 !important;
    }
    
    #addCustomerModal.modal-fullscreen-md-down .modal-body {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px) + 80px) !important;
    }
    
    /* التأكد من أن الأزرار مرئية دائماً */
    #addCustomerModal.modal-fullscreen-md-down .modal-footer .btn {
        min-height: 44px !important; /* الحد الأدنى للمساحة القابلة للنقر على الهاتف */
    }
    
    /* ===== إصلاح المساحة البيضاء الفارغة في نموذج إضافة رصيد للخزنة ===== */
    /* نماذج صغيرة لا تحتاج scrollable - مثل إضافة رصيد للخزنة */
    #addCashBalanceModal .modal-dialog {
        margin: 0.5rem !important;
        max-width: calc(100% - 1rem) !important;
        max-height: auto !important;
        height: auto !important;
    }
    
    #addCashBalanceModal .modal-content {
        max-height: none !important;
        height: auto !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    #addCashBalanceModal .modal-body {
        flex: 0 1 auto !important;
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
        padding-bottom: 1rem !important;
    }
    
    #addCashBalanceModal .modal-header,
    #addCashBalanceModal .modal-footer {
        flex-shrink: 0 !important;
    }
    
    /* ===== تحسينات الأداء للكتابة على الهاتف ===== */
    #addCashBalanceModal input,
    #addCashBalanceModal textarea,
    #addCashBalanceModal select {
        /* إزالة تأخير الـ touch على iOS/Android */
        touch-action: manipulation !important;
        /* تحسين rendering */
        will-change: contents !important;
        /* إزالة أي transitions قد تسبب التأخير */
        transition: none !important;
        /* تحسين font rendering */
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
        /* منع highlight عند اللمس */
        -webkit-tap-highlight-color: transparent !important;
        /* تحسين text rendering */
        text-rendering: optimizeSpeed !important;
        /* منع user-select delay */
        -webkit-user-select: text !important;
        user-select: text !important;
    }
    
    /* تحسين focus performance */
    #addCashBalanceModal input:focus,
    #addCashBalanceModal textarea:focus {
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        /* إزالة أي transitions */
        transition: none !important;
    }
    
    /* تحسين button performance */
    #addCashBalanceModal .btn {
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: transparent !important;
        /* إزالة transitions */
        transition: none !important;
    }
    
    /* تحسين modal rendering */
    #addCashBalanceModal.modal {
        /* تحسين compositing */
        transform: translateZ(0) !important;
        -webkit-transform: translateZ(0) !important;
        /* إزالة transitions */
        transition: none !important;
    }
    
    #addCashBalanceModal .modal-dialog {
        /* تحسين compositing */
        transform: translateZ(0) !important;
        -webkit-transform: translateZ(0) !important;
        /* إزالة transitions */
        transition: none !important;
    }
}

/* ===== Landscape Orientation Fix ===== */
@media (max-width: 768px) and (orientation: landscape) {
    .modal.show .modal-dialog {
        max-height: calc(100dvh - 0.5rem);
    }
    
    .modal-content {
        max-height: calc(100dvh - 0.5rem);
    }
    
    .modal-header {
        padding: 0.75rem 1rem;
    }
    
    .modal-body {
        padding: 0.75rem 1rem;
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px) + 20px);
    }
    
    .modal-footer {
        padding: 0.75rem 1rem;
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }
}

/* ===== Support for Dynamic Viewport Height ===== */
@supports (height: 100dvh) {
    @media (max-width: 768px) {
        .modal.show .modal-dialog,
        .modal.showing .modal-dialog {
            max-height: calc(100dvh - 1rem);
        }
        
        .modal-content {
            max-height: calc(100dvh - 1rem);
        }
    }
}

/* ===== تسريع إغلاق النماذج - إزالة جميع الـ transitions ===== */
@media (max-width: 768px) {
    /* إزالة transition من backdrop لإغلاق فوري */
    .modal-backdrop {
        transition: none !important;
    }
    
    /* إزالة animation الإغلاق تماماً */
    .modal.fade .modal-dialog {
        transition: none !important;
    }
    
    .modal.fade:not(.show) .modal-dialog {
        transform: none !important;
        opacity: 0 !important;
    }
}

